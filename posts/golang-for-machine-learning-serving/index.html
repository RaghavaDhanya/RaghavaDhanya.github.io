<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go faster with Go: Golang for ML Serving | AI Logs</title>
<meta name=keywords content="golang,cgo,mlops,multi-armed-bandit,python,ml,ai"><meta name=description content="So the ask is to do 3 Million Predictions per second with as little resources as possible. Thankfully its one of the simpler model of Recommendation systems, Multi Armed Bandit(MAB). Multi Armed bandit usually involves sampling from distribution like Beta Distribution. That&rsquo;s where the most time is spent. If we can concurrently do as many sampling as we can, we&rsquo;ll use the resources well. Maximizing Resource utilization is the key to reducing overall resources needed for the model."><meta name=author content="Raghava Dhanya"><link rel=canonical href=https://ai.ragv.in/posts/golang-for-machine-learning-serving/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://ai.ragv.in/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ai.ragv.in/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ai.ragv.in/favicon-32x32.png><link rel=apple-touch-icon href=https://ai.ragv.in/apple-touch-icon.png><link rel=mask-icon href=https://ai.ragv.in/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ai.ragv.in/posts/golang-for-machine-learning-serving/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-RGHWYFE1WN"></script><script>var dnt,doNotTrack=!1;if(!0&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-RGHWYFE1WN")}</script><meta property="og:title" content="Go faster with Go: Golang for ML Serving"><meta property="og:description" content="So the ask is to do 3 Million Predictions per second with as little resources as possible. Thankfully its one of the simpler model of Recommendation systems, Multi Armed Bandit(MAB). Multi Armed bandit usually involves sampling from distribution like Beta Distribution. That&rsquo;s where the most time is spent. If we can concurrently do as many sampling as we can, we&rsquo;ll use the resources well. Maximizing Resource utilization is the key to reducing overall resources needed for the model."><meta property="og:type" content="article"><meta property="og:url" content="https://ai.ragv.in/posts/golang-for-machine-learning-serving/"><meta property="og:image" content="https://ai.ragv.in/images/golang-for-machine-learning-serving/go_mab_wide.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-20T21:36:00+05:30"><meta property="article:modified_time" content="2022-06-20T21:36:00+05:30"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ai.ragv.in/images/golang-for-machine-learning-serving/go_mab_wide.png"><meta name=twitter:title content="Go faster with Go: Golang for ML Serving"><meta name=twitter:description content="So the ask is to do 3 Million Predictions per second with as little resources as possible. Thankfully its one of the simpler model of Recommendation systems, Multi Armed Bandit(MAB). Multi Armed bandit usually involves sampling from distribution like Beta Distribution. That&rsquo;s where the most time is spent. If we can concurrently do as many sampling as we can, we&rsquo;ll use the resources well. Maximizing Resource utilization is the key to reducing overall resources needed for the model."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ai.ragv.in/posts/"},{"@type":"ListItem","position":2,"name":"Go faster with Go: Golang for ML Serving","item":"https://ai.ragv.in/posts/golang-for-machine-learning-serving/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go faster with Go: Golang for ML Serving","name":"Go faster with Go: Golang for ML Serving","description":"So the ask is to do 3 Million Predictions per second with as little resources as possible. Thankfully its one of the simpler model of Recommendation systems, Multi Armed Bandit(MAB). Multi Armed bandit usually involves sampling from distribution like Beta Distribution. That\u0026rsquo;s where the most time is spent. If we can concurrently do as many sampling as we can, we\u0026rsquo;ll use the resources well. Maximizing Resource utilization is the key to reducing overall resources needed for the model.","keywords":["golang","cgo","mlops","multi-armed-bandit","python","ml","ai"],"articleBody":"So the ask is to do 3 Million Predictions per second with as little resources as possible. Thankfully its one of the simpler model of Recommendation systems, Multi Armed Bandit(MAB). Multi Armed bandit usually involves sampling from distribution like Beta Distribution. That’s where the most time is spent. If we can concurrently do as many sampling as we can, we’ll use the resources well. Maximizing Resource utilization is the key to reducing overall resources needed for the model.\nOur current prediction services are micro-services written in Python, and they follow the general structure of\nRequest -\u003e Features Fetch -\u003e Predict -\u003e Post process -\u003e Return\nA single request can require us to score thousands of user, content pairs. Python with GIL and multiprocessing can only get you so far, We have implemented batch sampling methods based on cython and C++ that get around the GIL and we use many workers based on number of cores to handle requests concurrently.\nThe current Python service with single node can do 192 RPS, about 400 pairs each. Only about 20% average CPU utilization. The limiting factor now was the language, the serving framework and the network call to feature store.\nWhy Golang? Golang is a statically typed language with great tooling. This means that errors are caught early and it is easy to refactor code. Concurrency is native to Golang, which is important for machine learning algorithms that can be run in parallel and for concurrent network calls to featurestore. It also benchmarks as one of the fastest serving languages here. It is also a compiled language, so its optimized well at compile time.\nPorting the existing MAB to Golang Basic idea, dividing the system in 3 parts\nBasic REST API for predict and health with stubs. Featurestore fetch, implement a module for it. Lift and shift the c++ sampling code using cgo #1 was easy, I chose Fiber framework for REST API. It seemed most welcoming, good documentation, expressjs like API. And it was also fairly up in the benchmarks.\nEarly code\nfunc main() { // setup fiber app := fiber.New() // catch all exception app.Use(recover.New()) // load model struct ctx := context.Background() md, err := model.NewModel(ctx) if err != nil { fmt.Println(err) } defer md.Close() // health API app.Get(\"/health\", func(c *fiber.Ctx) error { if err != nil { return fiber.NewError( fiber.StatusServiceUnavailable, fmt.Sprintf(\"Model couldn't load: %v\", err)) } return c.JSON(\u0026fiber.Map{ \"status\": \"ok\", }) }) // predict API app.Post(\"/predict\", func(c *fiber.Ctx) error { var request map[string]interface{} err := json.Unmarshal(c.Body(), \u0026request) if err != nil { return err } return c.JSON(md.Predict(request)) }) That’s it, Task #1 done. Took less than an hour.\nOn #2, it required slightly more learning on how to make structs with methods and goroutines. One of the major differentiator from C++, Python is that Golang doesn’t support full object oriented programming, mainly it doesn’t support inheritance. It’s also completely different in how the methods on structs are defined from other languages I’ve encountered.\nThe Featurestore we were using had the Golang client, all I had to do was write a wrapper around it to read concurrently large number of entities.\nThe basic structure I was going for was\ntype VertexFeatureStoreClient struct { //client reference to gcp's client } func NewVertexFeatureStoreClient(ctx context.Context,) (*VertexFeatureStoreClient, error) { // client creation code } func (vfs *VertexFeatureStoreClient) GetFeaturesByIdsChunk(ctx context.Context, featurestore, entityName string, entityIds []string, featureList []string) (map[string]map[string]interface{}, error) { // fetch code for 100 items } func (vfs *VertexFeatureStoreClient) GetFeaturesByIds(ctx context.Context, featurestore, entityName string, entityIds []string, featureList []string) (map[string]map[string]interface{}, error) { const chunkSize = 100 // limit from GCP // code to run each fetch concurrently featureChannel := make(chan map[string]map[string]interface{}) errorChannel := make(chan error) var count = 0 for i := 0; i \u003c len(entityIds); i += chunkSize { end := i + chunkSize if end \u003e len(entityIds) { end = len(entityIds) } go func(ents []string) { features, err := vfs.GetFeaturesByIdsChunk(ctx, featurestore, entityName, ents, featureList) if err != nil { errorChannel \u003c- err return } featureChannel \u003c- features }(entityIds[i:end]) count++ } results := make(map[string]map[string]interface{}, len(entityIds)) for { select { case err := \u003c-errorChannel: return nil, err case res := \u003c-featureChannel: for k, v := range res { results[k] = v } } count-- if count \u003c 1 { break } } return results, nil } func (vfs *VertexFeatureStoreClient) Close() error { //close code } Tips on Goroutine Always try to use channels, there are many tutorials using sync workgroups for Goroutine. Those are lower level APIs you won’t need for most cases. Channels are elegant way to run goroutines even if you don’t need to pass data, you can send flags in channel to collect. Goroutines are cheap virtual threads, you don’t have to worry about making too many of them and running on multiple cores. The latest golang can run that across cores for you.\nOn #3, it was the hardest part. Spent about a day of debugging to get it working. So if your use-case doesn’t need complex sampling and C++ I would suggest just going with Gonum you would save yourself lot of time.\nOne of the things I didn’t realize coming from cython was that I had to compile C++ files manually and load that in cgo include flags.\nheader file\n#ifndef BETA_DIST_H #define BETA_DIST_H #ifdef __cplusplus extern \"C\" { #endif double beta_sample(double, double, long); #ifdef __cplusplus } #endif #endif Notice extern C, it’s needed for C++ code to be usable in go, not needed for C due to mangling. Another gotcha was that I couldn’t do any #include statements in header file, cgo linking fails in that case(for unknown reason). So I moved those to .cpp file.\nTo compile it\ng++ -fPIC -I/usr/local/include -L/usr/local/lib betadist.cpp -shared -o libbetadist.so Once compiled you can use it cgo.\ncgo wrapper file\n/* #cgo CPPFLAGS: -I${SRCDIR}/cbetadist #cgo CPPFLAGS: -I/usr/local/include #cgo LDFLAGS: -Wl,-rpath,${SRCDIR}/cbetadist #cgo LDFLAGS: -L${SRCDIR}/cbetadist #cgo LDFLAGS: -L/usr/local/lib #cgo LDFLAGS: -lstdc++ #cgo LDFLAGS: -lbetadist #include */ import \"C\" func Betasample(alpha, beta float64, random int) float64 { return float64(C.beta_sample(C.double(alpha), C.double(beta), C.long(random))) } Notice -lbetadist in LDFLAGS that is to link libbetadist.so. You also have to run export DYLD_LIBRARY_PATH=/fullpath_to/folder_containing_so_file/. Then I could run go run . it worked usually like a go project.\nIntegrating them all together with simple model struct with predict method is simple and takes less time comparatively.\nResults Metric Python Go Max RPS 192 819 Max latency 78ms 110ms Max CPU util. ~20% ~55% That’s 4.3x improvement on RPS, that reduces our number of minimum node to 19 from 80, that’s a HUGE cost advantage. Max latency was slightly higher but that acceptable given python service saturates at 192 and degrades significantly if traffic raises beyond that.\nShould I convert all my models to Golang? Short answer: No.\nLong answer: Go has great advantage in serving, but Python is still king for experimentation. I would only suggest go if the model is simple and its a long running base model not experiment. Go is not mature for complex ML use-cases yet.\nSo the elephant in the room, Why not Rust? Well, Shiv did. Take a look. It is even faster than Go.\n","wordCount":"1181","inLanguage":"en","image":"https://ai.ragv.in/images/golang-for-machine-learning-serving/go_mab_wide.png","datePublished":"2022-06-20T21:36:00+05:30","dateModified":"2022-06-20T21:36:00+05:30","author":{"@type":"Person","name":"Raghava Dhanya"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ai.ragv.in/posts/golang-for-machine-learning-serving/"},"publisher":{"@type":"Person","name":"AI Logs","logo":{"@type":"ImageObject","url":"https://ai.ragv.in/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ai.ragv.in/ accesskey=h title="AI Logs (Alt + H)"><img src=https://ai.ragv.in/Logo_2_0.svg alt aria-label=logo height=30>AI Logs</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://ai.ragv.in/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://ai.ragv.in/categories/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://ai.ragv.in/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://ragv.in title=ragv.in><span>ragv.in</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://ai.ragv.in/archives title=Archives><span>Archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ai.ragv.in/>Home</a>&nbsp;»&nbsp;<a href=https://ai.ragv.in/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Go faster with Go: Golang for ML Serving</h1><div class=post-meta><span title='2022-06-20 21:36:00 +0530 +0530'>June 20, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Raghava Dhanya</div></header><figure class=entry-cover><img loading=eager src=https://ai.ragv.in/images/golang-for-machine-learning-serving/go_mab_wide.png alt="Golang's Gopher with tentacles"><p>Multi Armed Bandit in Golang</p></figure><div class=post-content><p>So the ask is to do <strong>3 Million Predictions per second</strong> with as little resources as possible. Thankfully its one of the simpler model of Recommendation systems, Multi Armed Bandit(MAB).
Multi Armed bandit usually involves sampling from distribution like <a href=https://en.wikipedia.org/wiki/Beta_distribution>Beta Distribution</a>. That&rsquo;s where the most time is spent. If we can concurrently do as many sampling as we can, we&rsquo;ll use the resources well. Maximizing Resource utilization is the key to reducing overall resources needed for the model.</p><p>Our current prediction services are micro-services written in Python, and they follow the general structure of</p><blockquote><p>Request -> Features Fetch -> Predict -> Post process -> Return</p></blockquote><p>A single request can require us to score thousands of user, content pairs. Python with GIL and multiprocessing can only get you so far, We have implemented <a href=/posts/python-with-a-dash-of-cpp-optimizing/>batch sampling</a> methods based on <code>cython</code> and <code>C++</code> that get around the GIL and we use many workers based on number of cores to handle requests concurrently.</p><p>The current Python service with single node can do 192 RPS, about 400 pairs each. Only about 20% average CPU utilization. The limiting factor now was the language, the serving framework and the network call to feature store.</p><h2 id=why-golang>Why Golang?<a hidden class=anchor aria-hidden=true href=#why-golang>#</a></h2><p>Golang is a statically typed language with great tooling. This means that errors are caught early and it is easy to refactor code. Concurrency is native to Golang, which is important for machine learning algorithms that can be run in parallel and for concurrent network calls to featurestore. It also benchmarks as one of the fastest serving languages <a href=https://www.techempower.com/benchmarks/>here</a>. It is also a compiled language, so its optimized well at compile time.</p><h2 id=porting-the-existing-mab-to-golang>Porting the existing MAB to Golang<a hidden class=anchor aria-hidden=true href=#porting-the-existing-mab-to-golang>#</a></h2><p>Basic idea, dividing the system in 3 parts</p><ol><li>Basic REST API for predict and health with stubs.</li><li>Featurestore fetch, implement a module for it.</li><li>Lift and shift the c++ sampling code using <a href=https://pkg.go.dev/cmd/cgo>cgo</a></li></ol><p>#1 was easy, I chose <a href=https://gofiber.io/>Fiber</a> framework for REST API. It seemed most welcoming, good documentation, expressjs like API. And it was also fairly up in the benchmarks.</p><p>Early code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// setup fiber
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>app</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// catch all exception
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>recover</span>.<span style=color:#a6e22e>New</span>())
</span></span><span style=display:flex><span>    <span style=color:#75715e>// load model struct
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>md</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>NewModel</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>md</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// health API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;/health&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>Ctx</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>NewError</span>(
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>, 
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Model couldn&#39;t load: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>Map</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ok&#34;</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>    <span style=color:#75715e>// predict API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#e6db74>&#34;/predict&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fiber</span>.<span style=color:#a6e22e>Ctx</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>request</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Body</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>request</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>md</span>.<span style=color:#a6e22e>Predict</span>(<span style=color:#a6e22e>request</span>))
</span></span><span style=display:flex><span>	})
</span></span></code></pre></div><p>That&rsquo;s it, Task #1 done. Took less than an hour.</p><p>On #2, it required slightly more learning on how to make <a href=https://gobyexample.com/methods>structs with methods</a> and <a href=https://gobyexample.com/channels>goroutines</a>. One of the major differentiator from C++, Python is that Golang doesn&rsquo;t support full object oriented programming, mainly it doesn&rsquo;t support inheritance. It&rsquo;s also completely different in how the methods on structs are defined from other languages I&rsquo;ve encountered.</p><p>The Featurestore we were using had the <a href=https://cloud.google.com/go/docs/reference/cloud.google.com/go/aiplatform/latest/apiv1#cloud_google_com_go_aiplatform_apiv1_FeaturestoreOnlineServingClient>Golang client</a>, all I had to do was write a wrapper around it to read concurrently large number of entities.</p><p>The basic structure I was going for was</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>VertexFeatureStoreClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//client reference to gcp&#39;s client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewVertexFeatureStoreClient</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,) (<span style=color:#f92672>*</span><span style=color:#a6e22e>VertexFeatureStoreClient</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span><span style=color:#75715e>// client creation code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>vfs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>VertexFeatureStoreClient</span>) <span style=color:#a6e22e>GetFeaturesByIdsChunk</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>featurestore</span>, <span style=color:#a6e22e>entityName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>entityIds</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>featureList</span> []<span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// fetch code for 100 items
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>vfs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>VertexFeatureStoreClient</span>) <span style=color:#a6e22e>GetFeaturesByIds</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>featurestore</span>, <span style=color:#a6e22e>entityName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>entityIds</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>featureList</span> []<span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chunkSize</span> = <span style=color:#ae81ff>100</span> <span style=color:#75715e>// limit from GCP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// code to run each fetch concurrently
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>featureChannel</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>errorChannel</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>count</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>entityIds</span>); <span style=color:#a6e22e>i</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>chunkSize</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>end</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>chunkSize</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>end</span> &gt; len(<span style=color:#a6e22e>entityIds</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>end</span> = len(<span style=color:#a6e22e>entityIds</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ents</span> []<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>features</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vfs</span>.<span style=color:#a6e22e>GetFeaturesByIdsChunk</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>featurestore</span>, <span style=color:#a6e22e>entityName</span>, <span style=color:#a6e22e>ents</span>, <span style=color:#a6e22e>featureList</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>errorChannel</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>featureChannel</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>features</span>
</span></span><span style=display:flex><span>		}(<span style=color:#a6e22e>entityIds</span>[<span style=color:#a6e22e>i</span>:<span style=color:#a6e22e>end</span>])
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}, len(<span style=color:#a6e22e>entityIds</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errorChannel</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>featureChannel</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>res</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>results</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>count</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span> &lt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>results</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>vfs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>VertexFeatureStoreClient</span>) <span style=color:#a6e22e>Close</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//close code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h4 id=tips-on-goroutine>Tips on Goroutine<a hidden class=anchor aria-hidden=true href=#tips-on-goroutine>#</a></h4><p>Always try to use channels, there are many tutorials using sync workgroups for Goroutine. Those are lower level APIs you won&rsquo;t need for most cases. Channels are elegant way to run goroutines even if you don&rsquo;t need to pass data, you can send flags in channel to collect. Goroutines are cheap virtual threads, you don&rsquo;t have to worry about making too many of them and running on multiple cores. The latest golang can run that across cores for you.</p><p>On #3, it was the hardest part. Spent about a day of debugging to get it working. So if your use-case doesn&rsquo;t need complex sampling and <code>C++</code> I would suggest just going with <a href=https://www.gonum.org/>Gonum</a> you would save yourself lot of time.</p><p>One of the things I didn&rsquo;t realize coming from <code>cython</code> was that I had to compile <code>C++</code> files manually and load that in cgo include flags.</p><p>header file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>#ifndef BETA_DIST_H
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define BETA_DIST_H
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef __cplusplus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>double</span> <span style=color:#a6e22e>beta_sample</span>(<span style=color:#66d9ef>double</span>, <span style=color:#66d9ef>double</span>, <span style=color:#66d9ef>long</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef __cplusplus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><p>Notice <code>extern C</code>, it&rsquo;s needed for <code>C++</code> code to be usable in go, not needed for <code>C</code> due to <a href=https://en.wikipedia.org/wiki/Name_mangling>mangling</a>. Another gotcha was that I couldn&rsquo;t do any <code>#include</code> statements in header file, cgo linking fails in that case(for unknown reason). So I moved those to <code>.cpp</code> file.</p><p>To compile it</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>g++ -fPIC -I/usr/local/include -L/usr/local/lib  betadist.cpp -shared -o libbetadist.so
</span></span></code></pre></div><p>Once compiled you can use it cgo.</p><p>cgo wrapper file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo CPPFLAGS: -I${SRCDIR}/cbetadist
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo CPPFLAGS: -I/usr/local/include
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo LDFLAGS: -Wl,-rpath,${SRCDIR}/cbetadist
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo LDFLAGS: -L${SRCDIR}/cbetadist
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo LDFLAGS: -L/usr/local/lib
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo LDFLAGS: -lstdc++
</span></span></span><span style=display:flex><span><span style=color:#75715e>#cgo LDFLAGS: -lbetadist
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include &lt;betadist.hpp&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Betasample</span>(<span style=color:#a6e22e>alpha</span>, <span style=color:#a6e22e>beta</span> <span style=color:#66d9ef>float64</span>, <span style=color:#a6e22e>random</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>float64</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> float64(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>beta_sample</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>double</span>(<span style=color:#a6e22e>alpha</span>), <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>double</span>(<span style=color:#a6e22e>beta</span>), <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>long</span>(<span style=color:#a6e22e>random</span>)))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Notice <code>-lbetadist</code> in <code>LDFLAGS</code> that is to link <code>libbetadist.so</code>. You also have to run <code>export DYLD_LIBRARY_PATH=/fullpath_to/folder_containing_so_file/</code>. Then I could run <code>go run .</code> it worked usually like a go project.</p><p>Integrating them all together with simple model struct with predict method is simple and takes less time comparatively.</p><h2 id=results>Results<a hidden class=anchor aria-hidden=true href=#results>#</a></h2><p><img loading=lazy src=/images/golang-for-machine-learning-serving/go_mab_qps.png alt="Stress testing result showing 819 QPS"></p><table><thead><tr><th style=text-align:center>Metric</th><th style=text-align:center>Python</th><th style=text-align:center>Go</th></tr></thead><tbody><tr><td style=text-align:center>Max RPS</td><td style=text-align:center>192</td><td style=text-align:center>819</td></tr><tr><td style=text-align:center>Max latency</td><td style=text-align:center>78ms</td><td style=text-align:center>110ms</td></tr><tr><td style=text-align:center>Max CPU util.</td><td style=text-align:center>~20%</td><td style=text-align:center>~55%</td></tr></tbody></table><p>That&rsquo;s <strong>4.3x</strong> improvement on RPS, that reduces our number of minimum node to 19 from 80, that&rsquo;s a <strong>HUGE</strong> cost advantage. Max latency was slightly higher but that acceptable given python service saturates at 192 and degrades significantly if traffic raises beyond that.</p><h3 id=should-i-convert-all-my-models-to-golang>Should I convert all my models to Golang?<a hidden class=anchor aria-hidden=true href=#should-i-convert-all-my-models-to-golang>#</a></h3><p>Short answer: No.</p><p>Long answer: Go has great advantage in serving, but Python is still king for experimentation. I would only suggest go if the model is simple and its a long running base model not experiment. Go is not mature for complex ML use-cases <a href=https://github.com/josephmisiti/awesome-machine-learning#go>yet</a>.</p><h3 id=so-the-elephant-in-the-room-why-not-rust>So the elephant in the room, Why not Rust?<a hidden class=anchor aria-hidden=true href=#so-the-elephant-in-the-room-why-not-rust>#</a></h3><p>Well, <a href=http://shvbsle.in/serving-ml-at-the-speed-of-rust/>Shiv did</a>. Take a look. It is even faster than Go.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ai.ragv.in/tags/golang/>Golang</a></li><li><a href=https://ai.ragv.in/tags/cgo/>Cgo</a></li><li><a href=https://ai.ragv.in/tags/mlops/>Mlops</a></li><li><a href=https://ai.ragv.in/tags/multi-armed-bandit/>Multi-Armed-Bandit</a></li><li><a href=https://ai.ragv.in/tags/python/>Python</a></li><li><a href=https://ai.ragv.in/tags/ml/>Ml</a></li><li><a href=https://ai.ragv.in/tags/ai/>Ai</a></li></ul></footer></article></main><footer class=footer><span>© 2023 <a href=https://ragv.in>Raghava Dhanya</a> | <a href=/license>License</a> |</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>